<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Open Mobile Alliance - LwM2M Registry</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">

    <!-- Font awesome for arrows -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
    <!-- Normalize CSS -->
    <link rel="stylesheet" href="/CSS/Normalize.css" />


    <link rel="shortcut icon" href="https://www.omaspecworks.org/wp-content/uploads/2018/01/favicon-1.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">
    <link rel="stylesheet" href="../../CSS/Site.css">
  </head>
  <body>
    <!-- This gets populated with the header.html using Javascript -->
    <div id="header"></div>
    <!-- Repository selection -->
    <button id="show-errors" hidden onclick="$('#errors').show(); $('#show-errors').hide(); $('#hide-errors').show()">Show errors</button>
    <button id="hide-errors" hidden onclick="$('#errors').hide(); $('#show-errors').show(); $('#hide-errors').hide()">Hide errors</button>
    <div hidden id="errors"></div>
    <div id="show-branch-selection" hidden>
        <button onclick="$('#branch-selection').show(); $('#show-branch-selection').hide();">Show release/branch selection</button>
    </div>
    <div id="branch-selection" hidden>
        <div id="github-info"></div>
        <div id="github-credentials">
            <div id="github-credentials-form">
                <!-- <div id="github-credentials-form"> -->
                    <span>Username: <input id="username" name="username" type="text"></span><span>Github Personal Access Token: <input id="user-access-token" name="user-access-token" type="password"></span><span><button onclick="handleSaveGithubCredentials()">Use Github credentials</button></span><span>You can create a personal access token <a href="https://github.com/settings/tokens" target="_blank">here</a></span>
                <!-- </div> -->
            </div>
            <button id="github-credentials-remove-button" hidden onclick="handleRemoveGithubCredentials()">Remove Github credentials</button>
        </div>
        <div>
            <span>
                Release/Branch:&nbsp;
            </span>
            <span>
                <select id="branch-selector-dd" onchange="handleBranchSelectorChange(this)">
                    <option value="" disabled >Select a branch/tag</option>
                </select>
            </span>
        </div>
    </div>
    <!-- Main content -->
    <div class="container">
      <div class="my-5">
        <h1>
          OMA LightweightM2M (LwM2M) Object and Resource Registry
        </h1>
      </div>
      <nav>
        <ul class="nav nav-tabs" id="nav-tab">
          <li id="nav-information-tab"
            class="active show"
            data-toggle="tab"
            data-target="#nav-information"
            type="button"
            role="presentation"
            aria-controls="nav-information"
            aria-selected="true"
          >
              <a href="#">Information</a>
          </li>
          <li
            class=""
            id="nav-profile-tab"
            data-toggle="tab"
            data-target="#nav-objectid-classes"
            type="button"
            role="presentation"
            aria-controls="nav-objectid-classes"
            aria-selected="false"
          >
              <a href="#">Object Classes</a>
          </li>
          <li
            class=""
            id="nav-resources-tab"
            data-toggle="tab"
            data-target="#nav-resources"
            type="button"
            role="presentation"
            aria-controls="nav-resources"
            aria-selected="false"
          >
            <a href="#">Resource</a>
          </li>
          <li
            class=""
            id="nav-reserved-tab"
            data-toggle="tab"
            data-target="#nav-reserved"
            type="button"
            role="presentation"
            aria-controls="nav-reserved"
            aria-selected="false"
          >
            <a href="#">Vendor Bulk Reservations</a>
          </li>
        </ul>
      </nav>
      <div class="tab-content" id="nav-tabContent">
        <div class="tab-pane fade active in" id="nav-information" role="tabpanel" aria-labelledby="nav-information-tab" tabindex="0">
        </div>
        <!-- ObjectID Classes -->
        <div class="tab-pane fade" id="nav-objectid-classes" role="tabpanel" aria-labelledby="nav-profile-tab" tabindex="0">
          <h2>
            ObjectID Classes
          </h2>
          <div id="objectid-classes"></div>
          <dynamic-table
            id="objectid-table"
            class="objectid-table"
          >
          </dynamic-table>
        </div>
        <!-- Resources Classes -->
        <div class="tab-pane fade" id="nav-resources" role="tabpanel" aria-labelledby="nav-resources-tab" tabindex="0">
          <h2>ResourceID Classes</h2>
          <div id="resourceid-classes"></div>
          <dynamic-table
            id="resourceid-table"
            class="resourceid-table"
          >
          </dynamic-table>
        </div>
        <!-- Vendor Bulk Reservations -->
        <div class="tab-pane fade" id="nav-reserved" role="tabpanel" aria-labelledby="nav-reserved-tab" tabindex="0">
          <dynamic-table
            id="reservedByVendors-table"
            class="reservedByVendors-table"
          >
        </div>
      </div>
    </div>
    <!-- end of Main content -->
    <!-- This gets populated with the header.html using Javascript -->
    <div id="footer"></div>
    <script src="../../Scripts/config.js"></script>
    <script type="module" src="../../Scripts/lwm2mregistry-tables.js"></script>
    <script>
      function handleBranchSelectorChange(selectObject) {
        // Clear the errors when selecting a different release/branch
        $('#show-errors').hide();
        $('#hide-errors').hide()
        $('#errors').html('');

        const selectObjValue = JSON.parse(selectObject.value);

        const {tagName} = selectObjValue;
        const {branchName} = selectObjValue;
        const {url} = selectObjValue;

        if (tagName)
        history.pushState({'pageTitle':document.title},'',`?releaseTagName=${tagName}`)

        if (branchName)
        history.pushState({'pageTitle':document.title},'',`?branchName=${branchName}`)

        fetchDDF(tagName || branchName, `${url}/DDF.xml`,'./reserved.xml',`${url}/Common.xml`);
      }

      function handleSaveGithubCredentials() {
        // $('#github-credentials-form').serializeArray();
        const username = $('#username').val();
        const password = $('#user-access-token').val();

        const formData = {};
        formData.username = username;
        formData.userAccessToken = password;

        window.localStorage.githubAuth = JSON.stringify(formData);

        $('#github-credentials-form').hide();
        $('#github-credentials-remove-button').show();
      }

      function handleRemoveGithubCredentials() {
        window.localStorage.removeItem('githubAuth');

        $('#github-credentials-form').show();
        $('#github-credentials-remove-button').hide();
      }

      function handleError(request, textStatus, errorThrow) {
        const rateLimit = request.getResponseHeader('X-RateLimit-Limit');
        const rateLimitRemaining = request.getResponseHeader('X-RateLimit-Remaining');
        const rateLimitResetTime = request.getResponseHeader('X-RateLimit-Reset');

        const errorMessage = request.responseJSON?.message || errorThrow?.message || errorThrow;

        let rateLimitWillResetAt;
        if (rateLimitResetTime) rateLimitWillResetAt = new Date(rateLimitResetTime * 1000);

        const $errorSelector = $('#errors');
        // Clear the errors so only show one at a time
        $errorSelector.html('');
        const $branchSelector = $('#branch-selector-dd');

        $branchSelector.append($('<option/>').val('').text('Error retrieving data'));

        $errorSelector.append(`${errorMessage}<br/>`);

        if (rateLimitRemaining === '0' && rateLimitWillResetAt)
        $errorSelector.append(`Github API Rate Limit Exceeded.<br/>This will reset at ${rateLimitWillResetAt.toString()}<br/>`);

        $('#show-errors').show();
      };

      // On back button
      window.onpopstate = (e) => {
        if(e.state){
            window.location.href = window.location.href;
            // document.getElementById("content").innerHTML = e.state.html;
            // document.title = e.state.pageTitle;
        } else {
            window.location.href = window.location.href;
        }
      };

      $(document).ready(() => {
        $('#header').load("../../header.html");
        $('#footer').load("../../footer.html");
        $('#nav-information').load("./_OMNAInformation.html").tab('show');

        $('#objectid-classes').load("./_ObjectIDClasses.html");
        $('#resourceid-classes').load("./_ResourceIDClasses.html");
      })

    </script>

    <script charset="utf-8" type="module">
      import {getRepositoryInfo} from "../../Scripts/getRepositoryInfo.js";

      window.formatObjectTableDDFLinkXmlCell = function formatObjectTableDDFLinkXmlCell(row) {
        return row.ddfLink ? `<a href="${row.ddfURL}" title="download xml file">${row.objectID}</a>` : `${row.objectID}`
      }

      window.formatObjectTableDDFEditorLinkCell = function formatObjectTableDDFEditorLinkCell(row) {
      return row.ddfLink ?
        `<a href="http://devtoolkit.openmobilealliance.org/OEditor/LWMOView?url=${encodeURIComponent(row.ddfURL)}" title="call the Editor">${row.objectID}</a>` :
        `${row.objectID}`
      }

      window.formatObjectTableTSLinkCell = function formatObjectTableTSLinkCell(row) {
        return row.tsLink ?
          `<a href="${row.tsURL}"><img src="../../Images/Windows_download.gif" title="Download TS" /></a>` :
          `-`
      }

      window.formatResourceIdTableTSLinkCell = function formatResourceIdTableTSLinkCell(row) {
        return row.tsLink > 0 ?
          `<a href="${row.tsURL}">${row.resourceName}</a>` : `${row.resourceName}`
      }

      $(document).ready(() => {

        const {owner,repo,productionBranchName,testBranchName,devBranchName,testUrlPrefix,devUrlPrefix,showBranchSelectionQueryString} = config;

        const {githubAuth} = window.localStorage;

        if (!githubAuth) {
          $('#github-credentials-form').show();
          $('#github-credentials-remove-button').hide();
        } else {
          $('#github-credentials-form').hide();
          $('#github-credentials-remove-button').show();
        }

        window.fetchDDF = function fetchDDF(branchOrReleaseTagName, ddfXMLFileURL, reservedXMLFileUrl, commonXMLFileUrl) {
          let urlPath = '';
          const urlPathArray = ddfXMLFileURL.split('/');

          if (urlPathArray[0].startsWith('http')) {
            for (let i = 0; i < urlPathArray.length - 2; i += 1) {
              urlPath += urlPathArray[i];
              urlPath += '/';
            }
          } else {
            throw new Error('Path for DDF.xml is wrong. It should be a full web URL beginning with HTTP or HTTPS');
          }

          // configure the ObjectID table
          const objectTable = document.getElementById('objectid-table')
          objectTable.columns = [
            { key: 'urn', title: 'URN / Verson', type: 'text', format: '', class: ''},
            { key: 'xmlLink', title: 'XML Name', type: 'function', format: window.formatObjectTableDDFLinkXmlCell, class: 'text-center'},
            { key: 'xmlEditor', title: 'LwM2M Editor', type: 'function', format: window.formatObjectTableDDFEditorLinkCell, class: 'text-center'},
            { key: 'name', title: 'Object Name', type: 'text', format: '', class: '', search: true},
            { key: 'owner', title: 'Owner', type: 'text', format: '', class: 'text-center', search: true},
            { key: 'tsLink', title: 'Technical Specification', type: 'function', format: window.formatObjectTableTSLinkCell, class: 'text-center'},
            { key: 'description', title: 'Description', type: 'text', format: '', class: '', search: true},
          ]

          objectTable.filters = [
            { key: 'urnSource', title: 'Source', type: 'text' },
            { key: 'name', title: 'Name', type: 'text' },
            { key: 'owner', title: 'Owner', type: 'text' },
            { key: 'version', title: 'Version', type: 'text' },
          ]

          objectTable.caption=`<a href="http://devtoolkit.openmobilealliance.org/OEditor/Register" title="click here to register a new (ext-label) Object ID">Register a new Object produced by a 3rd party SDO (Standards Development Organization</a>`

          // clear data store
          $.ajax({
            type: 'GET',
            async: false,
            url: ddfXMLFileURL,
            dataType: 'xml',
            success(xmlDoc) {
              const $xml = $(xmlDoc);
              const $items = $xml.find('Item');
              const newData = []

              // Clear the sore if needed

              $items.each(function processDDF () {
                const urn = $(this).find('URN').text();
                const objectID = $(this).find('ObjectID').text();
                const ddfLink = $(this).find('DDFLink').text();
                const tsLink = $(this).find('TSLink').text();
                const tsURL = $(this).find('TS').text();
                const name = $(this).find('Name').text();
                const owner = $(this).find('Owner').text();
                const version = $(this).find('Ver').text();
                const description = $(this).find('Description').text();
                const source = $(this).find('Source').text(); // Type of Object: 0 = defined by OMA, 1 = defined by external Standards Development Organizations, 2 = private or individual
                let ddfURL = $(this).find('DDF').text();

                const splitURN = urn.split(':');
                let urnSource = splitURN[3];

                const ddfUrlParts = ddfURL.split('/');
                if (ddfUrlParts.length === 1) {
                  ddfURL = `${branchOrReleaseTagName}/${ddfURL}`;
                } else if (ddfUrlParts[0] === 'version_history') {
                  ddfURL = `${branchOrReleaseTagName}/${ddfURL}`;
                }

                if (!urnSource || urnSource === 'oma') {
                  urnSource = 'OMA Labels'
                } else if (urnSource === 'ext') {
                  urnSource = 'Standards Organization Labels'
                } else if (urnSource === 'x') {
                  urnSource = 'Companies or Individuals'
                } else {
                  urnSource = 'Unknown'
                }

                ddfURL = urlPath + ddfURL;

                newData.push({
                  urn,
                  objectID,
                  ddfLink,
                  tsLink,
                  tsURL,
                  name,
                  owner,
                  version,
                  description,
                  source,
                  urnSource,
                  ddfURL
                })
              })
              objectTable.updateData(newData)

            },
            error(request, textStatus, errorThrown) {
              window.console.debug('request', request);
              window.console.debug('textStatus', textStatus);
              window.console.debug('errorThrown', errorThrown);
              // handleError(request, textStatus, `Unable to load DDF:\n${errorThrown}`);
            }
          })

          const reservedByVendorsTable = document.getElementById('reservedByVendors-table')
          reservedByVendorsTable.columns = [
            { key: 'objectIDRange', title: 'XML Name', type: 'text', format: '', class: 'text-center', search: true},
            { key: 'company', title: 'XML Name', type: 'text', format: '', class: 'text-center', search: true},
          ]

          reservedByVendorsTable.filters = [
            // { key: 'company', title: 'Company', type: 'text' },
          ]

          // Load the reserved.xml data and fill in the reserved objects table
          $.ajax({
            type: 'GET',
            async: false,
            url: reservedXMLFileUrl,
            dataType: 'xml',
            success(xmlDoc) {
              const $xml = $(xmlDoc);
              const $items = $xml.find('Item');
              const newData = []

              $items.each(function () {
                const objectIDStartRange = $(this).find('ObjectIDStartRange').text();
                const objectIDEndRange = $(this).find('ObjectIDEndRange').text();
                const company = $(this).find('Company').text();

                let objectIDRange = `${objectIDStartRange} - ${objectIDEndRange}`;
                if (objectIDStartRange === objectIDEndRange || !objectIDEndRange) {
                  objectIDRange = objectIDStartRange;
                }

                newData.push({
                  objectIDRange,
                  company
                })
              })

              reservedByVendorsTable.updateData(newData)
            },
            error(request, textStatus, errorThrown) {
              window.console.debug('request', request);
              window.console.debug('textStatus', textStatus);
              window.console.debug('errorThrown', errorThrown);
              handleError(request, textStatus, `Unable to load reserved XML:\n${errorThrown}`);
            },
          });

          const resourceidTable = document.getElementById('resourceid-table')
          resourceidTable.columns = [
            { key: 'resourceID', title: 'ResourceID*', type: 'text', format: '', class: 'text-center', search: true },
            { key: 'resourceName', title: 'Name/Technical Spec*', type: 'function', format: window.formatResourceIdTableTSLinkCell, search: true },
            { key: 'accessType', title: 'Operation*', type: 'text', format: '', class: 'text-center', search: false },
            { key: 'type', title: 'Type*', type: 'text', format: '', class: 'text-center', search: false },
            { key: 'range', title: 'Range/Enumeration*', type: 'text', format: '', class: 'text-center', search: false },
            { key: 'units', title: 'Units*', type: 'text', format: '', class: 'text-center', search: false },
            { key: 'submitter', title: 'Submitter', type: 'text', format: '', search: false },
            { key: 'description', title: 'Description', type: 'text', format: '', search: true },
          ]

          resourceidTable.filters = [
            { key: 'submitter', title: 'Submitter', type: 'text' },
            { key: 'resourceName', title: 'Name', type: 'text' },
            { key: 'accessType', title: 'Operations', type: 'text' },
            { key: 'type', title: 'Type', type: 'text' },
          ]

          resourceidTable.caption = `<a title="click here to register a new (Reusable) Resource ID" href="http://devtoolkit.openmobilealliance.org/OEditor/Register">Register a new Resource produced by 3rd parties.</a>`

          // Load the common.xml data and fill in the common objects table
          $.ajax({
            type: 'GET',
            async: false,
            url: commonXMLFileUrl,
            dataType: 'xml',
            success(xmlDoc) {
              const $xml = $(xmlDoc)
              const $items = $xml.find('Item')
              const newData = []

              $items.each(function () {
                const resourceID = $(this).attr('ID');
                const resourceName = $(this).find('Name').text();
                const accessType = $(this).find('Operations').text();
                const multipleInstance = $(this).find('MultipleInstances').text();
                const mandatory = $(this).find('Mandatory').text();
                const type = $(this).find('Type').text();
                const range = $(this).find('RangeEnumeration').text();
                const units = $(this).find('Units').text();
                const submitter = $(this).find('Submitter').text();
                const description = $(this).find('Description').text();
                const tsURL = $(this).find('TS').text();
                const tsLink = $(this).find('TSLink').text();

                newData.push({
                  resourceID,
                  resourceName,
                  accessType: accessType || 'none',
                  multipleInstance,
                  mandatory,
                  type: type || 'undefined',
                  range,
                  units,
                  submitter,
                  description,
                  tsURL,
                  tsLink,
                })

              })

              resourceidTable.updateData(newData)
            },
            error(request, textStatus, errorThrown) {
              window.console.debug('request', request);
              window.console.debug('textStatus', textStatus);
              window.console.debug('errorThrown', errorThrown);
              handleError(request, textStatus, `Unable to load common object XML:\n${errorThrown}`);
            }
          })

        }

        function setSelectedValue(selectObj, urlValueToSet) {
          let tagName;
          let branchName;
          let url;
          if (selectObj && selectObj.length > 0 && selectObj[0]) {
            selectObj = selectObj[0];

            selectObj.options[0].selected = true;

            for (let i = 0; i < selectObj.options.length; i++) {
              let selectObjVal;
              try {selectObjVal = JSON.parse(selectObj.options[i].value)} catch {}

              if (selectObjVal && selectObjVal.url === urlValueToSet) {
                selectObj.options[i].selected = true;
                break;
              }
          }

          const selectObjValue = JSON.parse(selectObj.value);

          tagName = selectObjValue.tagName;
          branchName = selectObjValue.branchName;
          url = selectObjValue.url;
        } else {
          branchName = productionBranchName;
          url = urlValueToSet;
        }

        fetchDDF(tagName || branchName, `${url}/DDF.xml`,'./reserved.xml',`${url}/Common.xml`);
      }

      const urlParams = new URLSearchParams(window.location.search);

      let branchName = urlParams.get('branchName') || urlParams.get('releaseTagName') || undefined;
      const showBranchSelection = urlParams.get(showBranchSelectionQueryString);

      if (showBranchSelection) {
        if (!branchName) {
          branchName = productionBranchName;
        }

        // Once the page has loaded, show the branch selection options
        $('#branch-selection').show();

        const environmentUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branchName}`;
          getRepositoryInfo(owner,repo, () => {setSelectedValue($('#branch-selector-dd'), environmentUrl)})
        } else {
          if (!branchName) {
            branchName = productionBranchName;
          }

          // If production then hide the branch/tag selector
          $('#branch-selection').remove();
          $('#show-branch-selection').remove(); // This could be show() if you wanted to give the end user a way to use the branch selector

          const environmentUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branchName}`;
            setSelectedValue($('#branch-selector-dd'), environmentUrl);
       }
      })
    </script>
  </body>
</html>
