<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Open Mobile Alliance - LwM2M Registry</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">

    <!-- Font awesome for arrows -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
    <!-- Normalize CSS -->
    <link rel="stylesheet" href="../../CSS/Normalize.css" />


    <link rel="shortcut icon" href="https://www.omaspecworks.org/wp-content/uploads/2018/01/favicon-1.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">
    <link rel="stylesheet" href="../../CSS/Site.css">
  </head>
  <body>
    <!-- This gets populated with the header.html using Javascript -->
    <div id="header"></div>
    <!-- Repository selection -->
    <button id="show-errors" hidden onclick="$('#errors').show(); $('#show-errors').hide(); $('#hide-errors').show()">Show errors</button>
    <button id="hide-errors" hidden onclick="$('#errors').hide(); $('#show-errors').show(); $('#hide-errors').hide()">Hide errors</button>
    <div hidden id="errors"></div>
    <div id="show-branch-selection" hidden>
        <button onclick="$('#branch-selection').show(); $('#show-branch-selection').hide();">Show release/branch selection</button>
    </div>
    <div id="branch-selection" hidden>
        <div id="github-info"></div>
        <div id="github-credentials">
            <div id="github-credentials-form">
                <!-- <div id="github-credentials-form"> -->
                    <span>Username: <input id="username" name="username" type="text"></span><span>Github Personal Access Token: <input id="user-access-token" name="user-access-token" type="password"></span><span><button onclick="handleSaveGithubCredentials()">Use Github credentials</button></span><span>You can create a personal access token <a href="https://github.com/settings/tokens" target="_blank">here</a></span>
                <!-- </div> -->
            </div>
            <button id="github-credentials-remove-button" hidden onclick="handleRemoveGithubCredentials()">Remove Github credentials</button>
        </div>
        <div>
            <span>
                Release/Branch:&nbsp;
            </span>
            <span>
                <select id="branch-selector-dd" onchange="handleBranchSelectorChange(this)">
                    <option value="" disabled >Select a branch/tag</option>
                </select>
            </span>
        </div>
    </div>
    <!-- Main content -->
    <div class="container">
      <div>
        <h1>
          OMA LightweightM2M (LwM2M) Object and Resource Registry
        </h1>
      </div>
      <nav>
        <ul class="nav nav-tabs" id="nav-tab">
          <li id="nav-information-tab"
            class="active show"
            data-toggle="tab"
            data-target="#nav-information"
            type="button"
            role="presentation"
            aria-controls="nav-information"
            aria-selected="true"
          >
              <a href="#">Information</a>
          </li>
          <li
            class=""
            id="nav-profile-tab"
            data-toggle="tab"
            data-target="#nav-objectid-classes"
            type="button"
            role="presentation"
            aria-controls="nav-objectid-classes"
            aria-selected="false"
          >
              <a href="#">Object Classes</a>
          </li>
          <li
            class=""
            id="nav-resources-tab"
            data-toggle="tab"
            data-target="#nav-resources"
            type="button"
            role="presentation"
            aria-controls="nav-resources"
            aria-selected="false"
          >
            <a href="#">Resource</a>
          </li>
          <li
            class=""
            id="nav-reserved-tab"
            data-toggle="tab"
            data-target="#nav-reserved"
            type="button"
            role="presentation"
            aria-controls="nav-reserved"
            aria-selected="false"
          >
            <a href="#">Vendor Bulk Reservations</a>
          </li>
        </ul>
      </nav>
      <div class="tab-content" id="nav-tabContent">
        <div class="tab-pane fade active in" id="nav-information" role="tabpanel" aria-labelledby="nav-information-tab" tabindex="0">
        </div>
        <!-- ObjectID Classes -->
        <div class="tab-pane fade" id="nav-objectid-classes" role="tabpanel" aria-labelledby="nav-profile-tab" tabindex="0">
          <h2>
            ObjectID Classes
          </h2>
          <div id="objectid-classes"></div>
          <dynamic-table
            id="objectid-table"
            class="objectid-table"
            data-store="objectid"
          >
          </dynamic-table>
        </div>
        <!-- Resources Classes -->
        <div class="tab-pane fade" id="nav-resources" role="tabpanel" aria-labelledby="nav-resources-tab" tabindex="0">
          <h2>ResourceID Classes</h2>
          <div id="resourceid-classes"></div>
          <dynamic-table
            id="resourceid-table"
            class="resourceid-table"
            data-store="resourceid"
          >
          </dynamic-table>
        </div>
        </div>
        <!-- Vendor Bulk Reservations -->
        <div class="tab-pane fade" id="nav-reserved" role="tabpanel" aria-labelledby="nav-reserved-tab" tabindex="0">
        </div>
      </div>
    </div>
    <!-- end of Main content -->
    <!-- This gets populated with the header.html using Javascript -->
    <div id="footer"></div>
    <script src="../../Scripts/config.js"></script>
    <script type="module" src="../../Scripts/lwm2mregistry-tables.js"></script>
    <script charset="utf-8" type="module">
      import {getRepositoryInfo} from "../../Scripts/getRepositoryInfo.js";

      window.formatObjectTableDDFLinkXmlCell = function formatObjectTableDDFLinkXmlCell(row) {
        return row.ddfLink ? `<a href="${row.ddfURL}" title="download xml file">${row.objectID}</a>` : `${row.objectID}`
      }

      window.formatObjectTableDDFEditorLinkCell = function formatObjectTableDDFEditorLinkCell(row) {
      return row.ddfLink ?
        `<a href="http://devtoolkit.openmobilealliance.org/OEditor/LWMOView?url=${encodeURIComponent(row.ddfURL)}" title="call the Editor">${row.objectID}</a>` :
        `${row.objectID}`
      }

      window.formatObjectTableTSLinkCell = function formatObjectTableTSLinkCell(row) {
        return row.tsLink ?
          `<a href="${row.tsURL}"><img src="../../Images/Windows_download.gif" title="Download TS" /></a>` :
          `-`
      }

      $(document).ready(() => {

        const {owner,repo,productionBranchName,testBranchName,devBranchName,testUrlPrefix,devUrlPrefix,showBranchSelectionQueryString} = config;

        $('#header').load("../../header.html");
        $('#footer').load("../../footer.html");
        $('#nav-information').load("./_OMNAInformation.html").tab('show');

        $('#objectid-classes').load("./_ObjectIDClasses.html");
        $('#resourceid-classes').load("./_ResourceIDClasses.html");

        const {githubAuth} = window.localStorage;

        if (!githubAuth) {
          $('#github-credentials-form').show();
          $('#github-credentials-remove-button').hide();
        } else {
          $('#github-credentials-form').hide();
          $('#github-credentials-remove-button').show();
        }



        function fetchDDF(branchOrReleaseTagName, ddfXMLFileURL, reservedXMLFileUrl, commonXMLFileUrl) {
          let urlPath = '';
          const urlPathArray = ddfXMLFileURL.split('/');

          if (urlPathArray[0].startsWith('http')) {
            for (let i = 0; i < urlPathArray.length - 2; i += 1) {
              urlPath += urlPathArray[i];
              urlPath += '/';
            }
          } else {
            throw new Error('Path for DDF.xml is wrong. It should be a full web URL beginning with HTTP or HTTPS');
          }

          // configure the ObjectID table
          const objectTable = document.getElementById('objectid-table')
          objectTable.columns = [
            { key: 'urn', title: 'URN / Verson', type: 'text', format: '', class: ''},
            { key: 'xmlLink', title: 'XML Name', type: 'function', format: window.formatObjectTableDDFLinkXmlCell, class: ''},
            { key: 'xmlEditor', title: 'LwM2M Editor', type: 'function', format: window.formatObjectTableDDFEditorLinkCell, class: ''},
            { key: 'name', title: 'Object Name', type: 'text', format: '', class: '', search: true},
            { key: 'owner', title: 'Owner', type: 'text', format: '', class: '', search: true},
            { key: 'tsLink', title: 'Technical Specification', type: 'function', format: window.formatObjectTableTSLinkCell, class: ''},
            { key: 'description', title: 'Description', type: 'text', format: '', class: '', search: true},
          ]

          objectTable.filters = [
            { key: 'urnSource', title: 'Source', type: 'text' },
            { key: 'name', title: 'Name', type: 'text' },
            { key: 'owner', title: 'Owner', type: 'text' },
            { key: 'version', title: 'Version', type: 'text' },
          ]

          // clear data store
          $.ajax({
            type: 'GET',
            async: false,
            url: ddfXMLFileURL,
            dataType: 'xml',
            success(xmlDoc) {
              const $xml = $(xmlDoc);
              const $items = $xml.find('Item');
              const newData = []

              // Clear the sore if needed

              $items.each(function processDDF () {
                const urn = $(this).find('URN').text();
                const objectID = $(this).find('ObjectID').text();
                const ddfLink = $(this).find('DDFLink').text();
                const tsLink = $(this).find('TSLink').text();
                const tsURL = $(this).find('TS').text();
                const name = $(this).find('Name').text();
                const owner = $(this).find('Owner').text();
                const version = $(this).find('Ver').text();
                const description = $(this).find('Description').text();
                const source = $(this).find('Source').text(); // Type of Object: 0 = defined by OMA, 1 = defined by external Standards Development Organizations, 2 = private or individual
                let ddfURL = $(this).find('DDF').text();

                const splitURN = urn.split(':');
                let urnSource = splitURN[3];

                const ddfUrlParts = ddfURL.split('/');
                if (ddfUrlParts.length === 1) {
                  ddfURL = `${branchOrReleaseTagName}/${ddfURL}`;
                } else if (ddfUrlParts[0] === 'version_history') {
                  ddfURL = `${branchOrReleaseTagName}/${ddfURL}`;
                }

                if (!urnSource || urnSource === 'oma') {
                  urnSource = 'OMA Labels'
                } else if (urnSource === 'ext') {
                  urnSource = 'Standards Organization Labels'
                } else if (urnSource === 'x') {
                  urnSource = 'Companies or Individuals'
                } else {
                  urnSource = 'Unknown'
                }

                ddfURL = urlPath + ddfURL;

                newData.push({
                  urn,
                  objectID,
                  ddfLink,
                  tsLink,
                  tsURL,
                  name,
                  owner,
                  version,
                  description,
                  source,
                  urnSource,
                  ddfURL
                })
              })
              objectTable.updateData(newData)

            },
            error(request, textStatus, errorThrown) {
              window.console.debug('request', request);
              window.console.debug('textStatus', textStatus);
              window.console.debug('errorThrown', errorThrown);
              // handleError(request, textStatus, `Unable to load DDF:\n${errorThrown}`);
            }
          })
        }

        function setSelectedValue(selectObj, urlValueToSet) {
          let tagName;
          let branchName;
          let url;
          if (selectObj && selectObj.length > 0 && selectObj[0]) {
            selectObj = selectObj[0];

            selectObj.options[0].selected = true;

            for (let i = 0; i < selectObj.options.length; i++) {
              let selectObjVal;
              try {selectObjVal = JSON.parse(selectObj.options[i].value)} catch {}

              if (selectObjVal && selectObjVal.url === urlValueToSet) {
                selectObj.options[i].selected = true;
                break;
              }
          }

          const selectObjValue = JSON.parse(selectObj.value);

          tagName = selectObjValue.tagName;
          branchName = selectObjValue.branchName;
          url = selectObjValue.url;
        } else {
          branchName = productionBranchName;
          url = urlValueToSet;
        }

        fetchDDF(tagName || branchName, `${url}/DDF.xml`,'./reserved.xml',`${url}/Common.xml`);
        // SetUpExpandableTDs();
        // TablesWithRowspanStyleChanges();

        // Removed this because we don't want to set the query string on the initial load of the page.
        // selectObj.dispatchEvent(new Event('change'));
      }

      const urlParams = new URLSearchParams(window.location.search);

      let branchName = urlParams.get('branchName') || urlParams.get('releaseTagName') || undefined;
      const showBranchSelection = urlParams.get(showBranchSelectionQueryString);

      if (showBranchSelection) {
        if (!branchName) {
          branchName = productionBranchName;
        }

        // Once the page has loaded, show the branch selection options
        $('#branch-selection').show();

        const environmentUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branchName}`;
          getRepositoryInfo(owner,repo, () => {setSelectedValue($('#branch-selector-dd'), environmentUrl)})
        } else {
          if (!branchName) {
            branchName = productionBranchName;
          }

          // If production then hide the branch/tag selector
          $('#branch-selection').remove();
          $('#show-branch-selection').remove(); // This could be show() if you wanted to give the end user a way to use the branch selector

          const environmentUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branchName}`;
            setSelectedValue($('#branch-selector-dd'), environmentUrl);
       }
      })
    </script>
  </body>
</html>
